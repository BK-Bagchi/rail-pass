<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Select Your Train</title>
    <link rel="stylesheet" href="../css/bootstrap.min.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <script src="../js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <%- include('../partials/navbar.ejs') %>
    <!-- Train Search Result -->
    <div class="container my-5">
        <h2 class="mb-4 fw-bold text-center text-primary">
            <i class="bi bi-train-front-fill me-2"></i> Available Trains
        </h2>

        <% if (trains && trains.length > 0) { %>
            <% trains.forEach(train => { %>
            <div class="card border-0 shadow-lg rounded-4 mb-4 overflow-hidden">
                <div class="card-body p-4">
                    <!-- Train Header -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                        <h4 class="fw-bold text-dark mb-1">
                            <i class="bi bi-train-front text-primary me-2"></i>
                            <%= train.trainName %>
                        </h4>
                        <small class="text-muted">Train Number: <%= train.trainNumber %></small><br>
                        <small class="text-muted">Journey Date: <%= journeyDate %></small>
                        </div>
                    </div>
                    <% let departureTime= "", arrivalTime = ""; %>
                    <!-- Route Section -->
                    <div class="row g-4 mb-3 align-items-center">
                        <div class="col-md-5 text-center">
                            <h5 class="fw-bold text-success mb-1"><%= fromStation %></h5>
                            <% if (fromStation === train.route.startingStation) { %>
                                <% departureTime = train.route.departureTime %>
                                <p class="mb-0 text-muted"> Departure: <%= train.route.departureTime %> </p>
                            <% } else { %>
                                <% train.route.betweenStations.forEach(station => { %>
                                    <% if (fromStation === station.stationName) { %>
                                        <% departureTime = station.departureTime %>
                                        <p class="mb-0 text-muted"> Arrival: <%= station.arrivalTime %> </p>
                                        <p class="mb-0 text-muted"> Departure: <%= station.departureTime %> </p>
                                    <% } %>
                                <% }) %>
                            <% } %>
                        </div>

                        <div class="col-md-2 text-center">
                            <i class="bi bi-arrow-right fs-2 text-primary"></i>
                        </div>

                        <div class="col-md-5 text-center">
                            <h5 class="fw-bold text-danger mb-1"><%= toStation %></h5>
                            <% if (toStation === train.route.endingStation) { %>
                                <% arrivalTime = train.route.arrivalTime %>
                                <p class="mb-0 text-muted"> Arrival: <%= train.route.arrivalTime %> </p>
                            <% } else { %>
                                <% train.route.betweenStations.forEach(station => { %>
                                    <% if (toStation === station.stationName) { %>
                                        <% arrivalTime = station.arrivalTime %>
                                        <p class="mb-0 text-muted"> Arrival: <%= station.arrivalTime %></p>
                                        <p class="mb-0 text-muted"> Departure: <%= station.departureTime %></p>
                                    <% } %>
                                <% }) %>
                            <% } %>
                        </div>
                    </div>

                    <!-- Stops -->
                    <% if (train.route.betweenStations && train.route.betweenStations.length > 0) { %>
                        <h6 class="fw-bold mt-3 mb-2">Stops:</h6>
                        <div class="d-flex flex-wrap gap-2">
                        <% for (let i = 0; i < trains.length; i++) { %>
                            <div class="border rounded-pill px-3 py-1 bg-light small mb-2">
                                <strong><%= trains[i].route.startingStation || "Unknown" %></strong>  
                                <span class="text-muted">(D: <%= trains[i].route.departureTime || "-" %>)</span>
                            </div>
                        <% } %>
                        <% train.route.betweenStations.forEach(station => { %>
                            <div class="border rounded-pill px-3 py-1 bg-light small">
                                <strong><%= station.stationName || "Unknown" %></strong>  
                                <span class="text-muted">(A: <%= station.arrivalTime || "-" %>, D: <%= station.departureTime || "-" %>)</span>
                            </div>
                        <% }) %>
                        <% for (let i = 0; i < trains.length; i++) { %>
                            <div class="border rounded-pill px-3 py-1 bg-light small mb-2">
                                <strong><%= trains[i].route.endingStation || "Unknown" %></strong>  
                                <span class="text-muted">(A: <%= trains[i].route.arrivalTime || "-" %>)</span>
                            </div>
                            <% } %>
                        </div>
                    <% } %>

                    <!-- Seat Availability -->
                    <h6 class="fw-bold mt-4 mb-2">Available Seats:</h6>
                    <div class="row g-2">
                        <% Object.keys(train.remainingSeats).forEach(type => { %>
                            <div class="col-md-3 col-6">
                                <form action="/booking/selectSeat/<%= train._id %>" method="POST">
                                    <input type="hidden" name="trainName" value="<%= train.trainName %>">
                                    <input type="hidden" name="fromStation" value="<%= fromStation %>">
                                    <input type="hidden" name="departureTime" value="<%= departureTime %>">
                                    <input type="hidden" name="toStation" value="<%= toStation %>">
                                    <input type="hidden" name="arrivalTime" value="<%= arrivalTime %>">
                                    <input type="hidden" name="seatClass" value="<%= type %>">
                                    <input type="hidden" name="journeyDate" value="<%= journeyDate %>">
                                    <input type="hidden" name="fareRate" value="<%= train.fare.farePerKilometer[type] * (journeyStations-1) %>">
                                    <button type="submit" class="border rounded-3 text-center p-2 shadow-sm w-100  <%= train.seats[type] > 0 ? 'bg-white' : 'bg-light text-muted' %>" style="text-decoration: none;" <%= train.seats[type] > 0 ? '' : 'disabled' %> >
                                        <!-- Seat Class -->
                                        <span class="fw-bold d-block"><%= type.replace("_", " ") %></span>                                
                                        <!-- Availability -->
                                        <% if (train.remainingSeats[type] > 0) { %>
                                        <span class="badge bg-success d-block mb-1">
                                            <%= train.remainingSeats[type] %> Seats Available
                                        </span>
                                        <% } else { %>
                                        <span class="badge bg-danger d-block mb-1">Sold Out</span>
                                        <% } %>                                       
                                        <!-- Fare -->
                                        <% if (train.fare && train.fare.farePerKilometer && typeof journeyStations !== 'undefined') { %>
                                            <small class="text-primary fw-semibold d-block">
                                                Fare: à§³ <%= train.fare.farePerKilometer[type] * (journeyStations-1) %>
                                            </small>
                                            <% } else { %>
                                            <small class="text-muted d-block">Fare not available</small>
                                        <% } %>
                                    </button>
                                </form>
                            </div>
                        <% }) %>
                    </div>
                </div>
            </div>
            <p>Total Stations: <%= journeyStations %></p>
            <% }) %>
        <% } else { %>
            <div class="text-center py-5">
                <i class="bi bi-emoji-frown fs-1 text-muted"></i>
                <p class="mt-3 fs-5 text-muted">No trains found for your search.</p>
            </div>
        <% } %>
    </div>
    <%- include('../partials/footer.ejs') %>
</body>
</html>